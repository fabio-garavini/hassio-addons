#!/usr/bin/with-contenv bashio
# shellcheck shell=bash

set -e

declare immich_port=$SERVER_PORT
declare immich_protocol=http
declare certfile="/ssl/$(bashio::config 'certfile')"
declare keyfile="/ssl/$(bashio::config 'keyfile')"

# Generate upstream configuration
bashio::var.json \
    port "^${immich_port}" \
    | tempio \
        -template /etc/nginx/templates/upstream.gtpl \
        -out /etc/nginx/includes/upstream.conf

if bashio::config.true 'ssl'; then
    # Require certfile and keyfile
    #bashio::config.require 'certfile'
    #bashio::config.require 'keyfile'

    # If certfile or keyfile does not exist, generate self-signed cert
    if ! bashio::fs.file_exists "$certfile" || ! bashio::fs.file_exists "$keyfile"; then
        bashio::log.warning "SSL is enabled, but certfile or keyfile is missing. Using self-signed certificate..."

        certfile="/data/ssl/fullchain.pem"
        keyfile="/data/ssl/privkey.pem"

        if ! bashio::fs.file_exists "$certfile" || ! bashio::fs.file_exists "$keyfile"; then
            /usr/local/bin/selfsigned-ssl-gen.sh "$certfile" "$keyfile"
        else
            /usr/local/bin/check-ssl.sh
        fi
    fi

    echo "$certfile" > /var/run/s6/container_environment/SSL_CERTFILE
    echo "$keyfile" > /var/run/s6/container_environment/SSL_KEYFILE
fi

bashio::var.json \
    certfile "$certfile" \
    keyfile "$keyfile" \
    port "8080" \
    protocol "${immich_protocol}" \
    ssl "^$(bashio::config 'ssl')" \
    | tempio \
        -template /etc/nginx/templates/direct.gtpl \
        -out /etc/nginx/servers/direct.conf
