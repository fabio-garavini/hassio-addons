#!/command/with-contenv bashio
# shellcheck shell=bash

set -e

OPTIONS_SOURCE=/data/options.json

if [ -z "${POWER_TOOLS_ENDPOINT_URL:-}" ]; then
  
  if ! ha_address="$(bashio::network.ipv4_address 2>/dev/null)"; then
    ha_address="homeassistant.local"
  else
    ha_address=${ha_address%%/*}
  fi

  if jq -e '.ssl == true' "$OPTIONS_SOURCE" > /dev/null; then
    scheme="https"
  else
    scheme="http"
  fi

  if ! port=$(bashio::addon.port 8080); then
    port=8080
  fi

  # Construct and write the endpoint URL
  POWER_TOOLS_ENDPOINT_URL="${scheme}://${ha_address}:${port}"
  export POWER_TOOLS_ENDPOINT_URL="${scheme}://${ha_address}:${port}"
  printf '%s' "${scheme}://${ha_address}:${port}" > /var/run/s6/container_environment/POWER_TOOLS_ENDPOINT_URL
fi

cd /app

# make redis folders
s6-setuidgid nextjs node server.js