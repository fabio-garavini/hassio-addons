#!/usr/bin/with-contenv bashio
# shellcheck shell=bash

set -e

OPTIONS_SOURCE=/data/options.json

certfile="/ssl/$(jq -r '.certfile' $OPTIONS_SOURCE)"
keyfile="/ssl/$(jq -r '.keyfile' $OPTIONS_SOURCE)"

# If certfile or keyfile does not exist, generate self-signed cert
if [ ! -f "$certfile" ] || [ ! -f "$keyfile" ]; then
    bashio::log.warning "SSL is enabled, but either certfile, keyfile or both are missing. Falling back to a self-signed certificate..."

    certfile="/data/ssl/fullchain.pem"
    keyfile="/data/ssl/privkey.pem"

    /usr/local/bin/ssl-check-generate.sh "$certfile" "$keyfile" true
else
    /usr/local/bin/ssl-check-generate.sh "$certfile" "$keyfile" false
fi

printf '{
  "certfile": "%s",
  "keyfile": "%s"
}' "$certfile" "$keyfile" \
    | tempio \
        -template /etc/nginx/templates/ssl.gtpl \
        -out /config/nginx/ssl.conf
