#!/bin/bash
set -e

echo "  Loading env variables:"

OPTIONS_SOURCE=/data/options.json

jq -r '
    reduce to_entries[] as $item (
        {};
        if $item.value | type == "object" then
        . + $item.value
        else
        . + { ($item.key): $item.value }
        end
    )
    | to_entries[]
    | "\(.key)\u0000\(.value|tostring)"
    ' $OPTIONS_SOURCE | while read -r -d $'\0' key && read -r value; do

    line="$key=$value"

    # log redacted config
    case "$key" in
        *PASS*|*SECRET*|*KEY*|*TOKEN*)
            echo "  $key=******"
            ;;
        *)
            echo "  $line"
            ;;
    esac

    export line

    # set .env
    echo "$line" >> /.env || true

    # set /etc/environment
    echo "$line" >> /etc/environment

    # For s6
    if [ -d /var/run/s6/container_environment ]; then
        printf "%s" "$value" > /var/run/s6/container_environment/"$key"
    fi

    echo "export $line" >> ~/.bashrc
done

if [ -n "$TZ" ] && [ -f /etc/localtime ]; then
    if [ -f /usr/share/zoneinfo/"$TZ" ]; then
        echo "Timezone set to $TZ"
        ln -snf /usr/share/zoneinfo/"$TZ" /etc/localtime
        echo "$TZ" >/etc/timezone
    fi
fi

if [ -f "/data/gitea.db" ]; then
    mv "/data/gitea.db" "/config/gitea.db"
fi

if [ "${USER}" != "git" ]; then
    # Rename user
    sed -i -e "s/^git\:/${USER}\:/g" /etc/passwd
fi

if [ -z "${USER_GID}" ]; then
    USER_GID="$(id -g "$USER")"
fi

if [ -z "${USER_UID}" ]; then
    USER_UID="$(id -u "$USER")"
fi

# Change GID for USER?
if [ -n "${USER_GID}" ] && [ "${USER_GID}" != "$(id -u "$USER")" ]; then
    sed -i -e "s/^${USER}:\([^:]*\):[0-9]*/${USER}:\1:${USER_GID}/" /etc/group
    sed -i -e "s/^${USER}:\([^:]*\):\([0-9]*\):[0-9]*/${USER}:\1:\2:${USER_GID}/" /etc/passwd
fi

# Change UID for USER?
if [ -n "${USER_UID}" ] && [ "${USER_UID}" != "$(id -u "$USER")" ]; then
    sed -i -e "s/^${USER}:\([^:]*\):[0-9]*:\([0-9]*\)/${USER}:\1:${USER_UID}:\2/" /etc/passwd
fi

for FOLDER in /data/logs /share/gitea /data/ssh; do
    mkdir -p ${FOLDER}
done

chown "$USER_UID:$USER_GID" -R /data /config /share/gitea

if [ $# -gt 0 ]; then
    exec "$@"
else
    exec /bin/s6-svscan /etc/s6
fi